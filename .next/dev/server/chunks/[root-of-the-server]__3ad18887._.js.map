{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/PROJECTOS/Reactjs/Celu/project-bolt-sb1-r7qsskrc/funcional/project/lib/supabase/admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\n\r\n/**\r\n * Supabase Admin client using SERVICE_ROLE_KEY.\r\n * USE ONLY ON THE SERVER (Route Handlers, Server Actions).\r\n * This client bypasses RLS.\r\n */\r\nexport function createAdminClient() {\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n\r\n    if (!supabaseUrl || !supabaseServiceKey) {\r\n        throw new Error('[ADMIN] Supabase URL or Service Role Key is missing. Check your environment variables.');\r\n    }\r\n\r\n    return createClient(supabaseUrl || '', supabaseServiceKey || '', {\r\n        auth: {\r\n            autoRefreshToken: false,\r\n            persistSession: false\r\n        }\r\n    })\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,SAAS;IACZ,MAAM;IACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;QACrC,MAAM,IAAI,MAAM;IACpB;IAEA,OAAO,IAAA,iRAAY,EAAC,eAAe,IAAI,sBAAsB,IAAI;QAC7D,MAAM;YACF,kBAAkB;YAClB,gBAAgB;QACpB;IACJ;AACJ"}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///D:/PROJECTOS/Reactjs/Celu/project-bolt-sb1-r7qsskrc/funcional/project/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\r\nimport { cookies } from 'next/headers'\r\n\r\n/**\r\n * Creates a Supabase client for use in Server Components, Route Handlers, and Server Actions.\r\n * In Next.js 16, cookies() is asynchronous.\r\n */\r\nexport async function createClient() {\r\n    const cookieStore = await cookies()\r\n\r\n    return createServerClient(\r\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n        {\r\n            cookies: {\r\n                getAll() {\r\n                    return cookieStore.getAll()\r\n                },\r\n                setAll(cookiesToSet) {\r\n                    try {\r\n                        cookiesToSet.forEach(({ name, value, options }) =>\r\n                            cookieStore.set(name, value, options)\r\n                        )\r\n                    } catch {\r\n                        // The `setAll` method was called from a Server Component.\r\n                        // This can be ignored if you have middleware refreshing\r\n                        // user sessions.\r\n                    }\r\n                },\r\n            },\r\n        }\r\n    )\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAMO,eAAe;IAClB,MAAM,cAAc,MAAM,IAAA,6NAAO;IAEjC,OAAO,IAAA,kRAAkB,sUAGrB;QACI,SAAS;YACL;gBACI,OAAO,YAAY,MAAM;YAC7B;YACA,QAAO,YAAY;gBACf,IAAI;oBACA,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC1C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAErC,EAAE,OAAM;gBACJ,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACrB;YACJ;QACJ;IACJ;AAER"}},
    {"offset": {"line": 101, "column": 0}, "map": {"version":3,"sources":["file:///D:/PROJECTOS/Reactjs/Celu/project-bolt-sb1-r7qsskrc/funcional/project/lib/supabase/error.ts"],"sourcesContent":["/**\r\n * Serializa erros Supabase/Postgrest para logs e respostas JSON.\r\n * Evita \"{}\" no console quando o objeto não é enumerável.\r\n */\r\nexport function serializeSupabaseError(err: unknown): {\r\n    message: string;\r\n    code?: string;\r\n    details?: unknown;\r\n    hint?: string;\r\n    status?: number;\r\n    name?: string;\r\n} {\r\n    if (err == null) return { message: 'Unknown error' };\r\n\r\n    const e = err as Record<string, unknown>;\r\n    return {\r\n        message: typeof e?.message === 'string' ? e.message : String(err),\r\n        code: typeof e?.code === 'string' ? e.code : undefined,\r\n        details: e?.details,\r\n        hint: typeof e?.hint === 'string' ? e.hint : undefined,\r\n        status: typeof e?.status === 'number' ? e.status : undefined,\r\n        name: typeof e?.name === 'string' ? e.name : undefined,\r\n    };\r\n}\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;AACM,SAAS,uBAAuB,GAAY;IAQ/C,IAAI,OAAO,MAAM,OAAO;QAAE,SAAS;IAAgB;IAEnD,MAAM,IAAI;IACV,OAAO;QACH,SAAS,OAAO,GAAG,YAAY,WAAW,EAAE,OAAO,GAAG,OAAO;QAC7D,MAAM,OAAO,GAAG,SAAS,WAAW,EAAE,IAAI,GAAG;QAC7C,SAAS,GAAG;QACZ,MAAM,OAAO,GAAG,SAAS,WAAW,EAAE,IAAI,GAAG;QAC7C,QAAQ,OAAO,GAAG,WAAW,WAAW,EAAE,MAAM,GAAG;QACnD,MAAM,OAAO,GAAG,SAAS,WAAW,EAAE,IAAI,GAAG;IACjD;AACJ"}},
    {"offset": {"line": 126, "column": 0}, "map": {"version":3,"sources":["file:///D:/PROJECTOS/Reactjs/Celu/project-bolt-sb1-r7qsskrc/funcional/project/app/api/ads/public/route.ts"],"sourcesContent":["/**\r\n * GET /api/ads/public\r\n * Lista anúncios: publicados (published + owner approved) + se autenticado, os próprios (qualquer status).\r\n * Usa service role. Funciona para anônimo e autenticado.\r\n */\r\nimport { NextResponse } from 'next/server'\r\nimport { createAdminClient } from '@/lib/supabase/admin'\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { serializeSupabaseError } from '@/lib/supabase/error'\r\n\r\nconst BUCKET = 'ad-images'\r\n\r\nfunction buildPublicUrl(path: string): string {\r\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n    if (!url) return ''\r\n    const clean = path.replace(/^\\/+|\\/+$/g, '')\r\n    return `${url}/storage/v1/object/public/${BUCKET}/${clean}`\r\n}\r\n\r\nfunction rowToAd(\r\n    r: Record<string, unknown>,\r\n    images: string[],\r\n    userName?: string\r\n) {\r\n    return {\r\n        id: r.id,\r\n        userId: r.owner_id,\r\n        userName: userName ?? undefined,\r\n        type: r.type,\r\n        status: r.status,\r\n        title: r.title,\r\n        description: r.description,\r\n        price: r.price_mzn != null ? Number(r.price_mzn) : null,\r\n        priceOnRequest: r.price_note != null && String(r.price_note).length > 0,\r\n        location: r.city,\r\n        province: r.province,\r\n        neighborhood: r.neighborhood ?? undefined,\r\n        categoryId: r.category,\r\n        whatsapp: r.whatsapp,\r\n        images,\r\n        likes: 0,\r\n        createdAt: r.created_at,\r\n        updatedAt: r.updated_at,\r\n    }\r\n}\r\n\r\nexport const dynamic = 'force-dynamic'\r\nexport const revalidate = 0\r\n\r\nexport async function GET(request: Request) {\r\n    try {\r\n        const { searchParams } = new URL(request.url)\r\n        const category = searchParams.get('category') ?? ''\r\n        const q = searchParams.get('q') ?? ''\r\n        const city = searchParams.get('city') ?? ''\r\n        const page = Math.max(1, parseInt(searchParams.get('page') ?? '1', 10))\r\n        const limit = 100\r\n        const offset = (page - 1) * limit\r\n\r\n        const admin = createAdminClient()\r\n        const supabase = await createClient()\r\n        const { data: { user } } = await supabase.auth.getUser()\r\n\r\n        let query = admin\r\n            .from('ads')\r\n            .select(`\r\n                id, owner_id, type, status, title, description, price_mzn, price_note,\r\n                province, city, neighborhood, category, whatsapp, created_at, updated_at\r\n            `)\r\n            .order('updated_at', { ascending: false })\r\n            .range(offset, offset + limit - 1)\r\n\r\n        if (category) query = query.eq('category', category)\r\n        if (city) query = query.eq('city', city)\r\n        if (q && q.trim()) {\r\n            const term = `%${q.trim()}%`\r\n            query = query.or(`title.ilike.${term},description.ilike.${term}`)\r\n        }\r\n\r\n        const { data: adsRows, error: adsError } = await query\r\n\r\n        if (adsError) {\r\n            const ser = serializeSupabaseError(adsError)\r\n            console.error('[API/ADS/PUBLIC] ads error:', ser)\r\n            return NextResponse.json({ ok: false, ...ser }, { status: 500 })\r\n        }\r\n\r\n        let rows = (adsRows ?? []) as Array<{\r\n            id: string\r\n            owner_id: string\r\n            type: string\r\n            status: string\r\n            title: string\r\n            description: string\r\n            price_mzn: number | null\r\n            price_note: string | null\r\n            province: string\r\n            city: string\r\n            neighborhood: string | null\r\n            category: string\r\n            whatsapp: string\r\n            created_at: string\r\n            updated_at: string\r\n        }>\r\n\r\n        let ownAds: typeof rows = []\r\n        if (user) {\r\n            const { data: own } = await admin\r\n                .from('ads')\r\n                .select(`\r\n                    id, owner_id, type, status, title, description, price_mzn, price_note,\r\n                    province, city, neighborhood, category, whatsapp, created_at, updated_at\r\n                `)\r\n                .eq('owner_id', user.id)\r\n            ownAds = (own ?? []) as typeof rows\r\n        }\r\n\r\n        const ownerIds = [...new Set([...rows.map((r) => r.owner_id), ...ownAds.map((r) => r.owner_id)])]\r\n        const { data: profiles } = await admin\r\n            .from('profiles')\r\n            .select('id, full_name, status')\r\n            .in('id', ownerIds)\r\n\r\n        const approvedIds = new Set(\r\n            (profiles ?? []).filter((p: { status: string }) => p.status === 'approved').map((p: { id: string }) => p.id)\r\n        )\r\n        const profileMap = new Map((profiles ?? []).map((p: { id: string; full_name: string }) => [p.id, p.full_name]))\r\n\r\n        const publicRows = rows.filter((r) => r.status === 'published' && approvedIds.has(r.owner_id))\r\n        const ownIds = new Set(ownAds.map((r) => r.id))\r\n        const merged = [...ownAds, ...publicRows.filter((r) => !ownIds.has(r.id))]\r\n        const adIds = merged.map((r) => r.id)\r\n        const { data: imgRows } = await admin\r\n            .from('ad_images')\r\n            .select('ad_id, path, sort_order')\r\n            .in('ad_id', adIds)\r\n            .order('sort_order', { ascending: true })\r\n\r\n        const imagesByAd = new Map<string, { path: string; sort_order: number }[]>()\r\n        for (const r of (imgRows ?? []) as { ad_id: string; path: string; sort_order: number }[]) {\r\n            const list = imagesByAd.get(r.ad_id) ?? []\r\n            list.push({ path: r.path, sort_order: r.sort_order })\r\n            imagesByAd.set(r.ad_id, list)\r\n        }\r\n\r\n        const ads = merged.map((r) => {\r\n            const imgs = (imagesByAd.get(r.id) ?? []).sort((a, b) => a.sort_order - b.sort_order)\r\n            return rowToAd(r, imgs.map((i) => buildPublicUrl(i.path)), profileMap.get(r.owner_id))\r\n        })\r\n\r\n        console.log('[API/ADS/PUBLIC] returning', ads.length, 'ads')\r\n        return NextResponse.json({ ads, total: ads.length })\r\n    } catch (err: unknown) {\r\n        const ser = serializeSupabaseError(err)\r\n        console.error('[API/ADS/PUBLIC] unexpected error:', ser)\r\n        return NextResponse.json({ ok: false, message: ser.message }, { status: 500 })\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}