{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/PROJECTOS/Reactjs/Celu/project-bolt-sb1-r7qsskrc/funcional/project/lib/supabase/admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\n\r\n/**\r\n * Supabase Admin client using SERVICE_ROLE_KEY.\r\n * USE ONLY ON THE SERVER (Route Handlers, Server Actions).\r\n * This client bypasses RLS.\r\n */\r\nexport function createAdminClient() {\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n\r\n    if (!supabaseUrl || !supabaseServiceKey) {\r\n        throw new Error('[ADMIN] Supabase URL or Service Role Key is missing. Check your environment variables.');\r\n    }\r\n\r\n    return createClient(supabaseUrl || '', supabaseServiceKey || '', {\r\n        auth: {\r\n            autoRefreshToken: false,\r\n            persistSession: false\r\n        }\r\n    })\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,SAAS;IACZ,MAAM;IACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;QACrC,MAAM,IAAI,MAAM;IACpB;IAEA,OAAO,IAAA,iRAAY,EAAC,eAAe,IAAI,sBAAsB,IAAI;QAC7D,MAAM;YACF,kBAAkB;YAClB,gBAAgB;QACpB;IACJ;AACJ"}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///D:/PROJECTOS/Reactjs/Celu/project-bolt-sb1-r7qsskrc/funcional/project/app/api/profile/ensure/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createAdminClient } from '@/lib/supabase/admin'\r\n\r\n/**\r\n * REGRA CRÍTICA: Se profile já existe com status 'approved' ou 'rejected',\r\n * NUNCA sobrescrever status/role. Isso evita \"aprovado mas preso em ativação\".\r\n */\r\nexport async function POST(request: Request) {\r\n    try {\r\n        const { id, email, full_name, avatar_url, whatsapp, province, city, account_type } = await request.json()\r\n\r\n        if (!id || !email) {\r\n            return NextResponse.json(\r\n                { error: 'Missing id or email' },\r\n                { status: 400 }\r\n            )\r\n        }\r\n\r\n        const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n        if (!supabaseServiceKey) {\r\n            console.error('[API/PROFILE/ENSURE] Missing SUPABASE_SERVICE_ROLE_KEY in environment');\r\n            return NextResponse.json(\r\n                { error: 'Configuração do servidor incompleta (Missing Service Key). Verifique o ficheiro .env' },\r\n                { status: 500 }\r\n            )\r\n        }\r\n\r\n        const supabase = createAdminClient()\r\n        const isSpecialAdmin = ['sunyldjosesomailamatapa@gmail.com', 'celupublic@gmail.com'].includes(email.toLowerCase())\r\n        const emailNorm = email.toLowerCase()\r\n\r\n        // 1) SELECT existente primeiro - NUNCA desaprovar quem já foi aprovado/rejeitado\r\n        const { data: existing } = await supabase\r\n            .from('profiles')\r\n            .select('id, status, role')\r\n            .eq('id', id)\r\n            .maybeSingle()\r\n\r\n        const preserveStatus = existing && ['approved', 'rejected'].includes(existing.status || '')\r\n\r\n        if (preserveStatus) {\r\n            console.log('[ENSURE] existing profile status/role preserved:', {\r\n                userId: id.slice(0, 8),\r\n                status: existing!.status,\r\n                role: existing!.role,\r\n                message: 'NOT overwriting - user was already approved/rejected'\r\n            })\r\n            const { data: profile } = await supabase\r\n                .from('profiles')\r\n                .select('*')\r\n                .eq('id', id)\r\n                .single()\r\n            return NextResponse.json(profile)\r\n        }\r\n\r\n        const role = isSpecialAdmin ? 'admin' : (existing?.role || 'seller')\r\n        const status = isSpecialAdmin ? 'approved' : (existing?.status || 'pending')\r\n\r\n        const upsertPayload: Record<string, unknown> = {\r\n            id,\r\n            email: emailNorm,\r\n            full_name: full_name || 'Usuário',\r\n            whatsapp: whatsapp || null,\r\n            province: province || null,\r\n            city: city || null,\r\n            account_type: ['seller', 'provider', 'both'].includes(account_type) ? account_type : 'seller',\r\n            role,\r\n            status,\r\n            updated_at: new Date().toISOString()\r\n        }\r\n\r\n        const { data: profile, error } = await supabase\r\n            .from('profiles')\r\n            .upsert(upsertPayload, { onConflict: 'id' })\r\n            .select()\r\n            .single()\r\n\r\n        if (error) {\r\n            console.error('[API/PROFILE/ENSURE] Upsert error:', error)\r\n            return NextResponse.json({ error: error.message }, { status: 500 })\r\n        }\r\n\r\n        // 2) Garantir seller_request apenas para pending\r\n        if (status === 'pending' && role !== 'admin') {\r\n            console.log('[API/PROFILE/ENSURE] Ensuring seller_request for pending user:', {\r\n                userId: id.slice(0, 8),\r\n                email: email.toLowerCase().slice(0, 20),\r\n                role,\r\n                status\r\n            })\r\n\r\n            const { data: requestData, error: reqError } = await supabase\r\n                .from('seller_requests')\r\n                .upsert({\r\n                    user_id: id,\r\n                    status: 'pending'\r\n                }, { onConflict: 'user_id' })\r\n                .select()\r\n\r\n            if (reqError) {\r\n                console.error('[API/PROFILE/ENSURE] Seller request upsert ERROR:', {\r\n                    userId: id.slice(0, 8),\r\n                    error: reqError.message,\r\n                    code: reqError.code,\r\n                    details: reqError.details,\r\n                    hint: reqError.hint\r\n                })\r\n                // Não falhar a requisição se seller_request falhar - trigger pode criar depois\r\n            } else if (requestData && requestData.length > 0) {\r\n                console.log('[API/PROFILE/ENSURE] Seller request ensured SUCCESS:', {\r\n                    userId: id.slice(0, 8),\r\n                    requestId: requestData[0].id?.slice(0, 8),\r\n                    requestStatus: requestData[0].status,\r\n                    created: !!requestData[0].id\r\n                })\r\n            } else {\r\n                console.warn('[API/PROFILE/ENSURE] Seller request upsert returned empty data:', {\r\n                    userId: id.slice(0, 8),\r\n                    warning: 'No data returned from upsert'\r\n                })\r\n            }\r\n        } else {\r\n            console.log('[API/PROFILE/ENSURE] Skipping seller_request creation:', {\r\n                userId: id.slice(0, 8),\r\n                reason: status === 'pending' ? 'user is admin' : 'user is approved',\r\n                status,\r\n                role\r\n            })\r\n        }\r\n\r\n        console.log('[API/PROFILE/ENSURE] Profile ensured successfully:', {\r\n            userId: id.slice(0, 8),\r\n            email: email.toLowerCase().slice(0, 20),\r\n            role,\r\n            status,\r\n            isAdmin: isSpecialAdmin,\r\n            profileId: profile?.id?.slice(0, 8)\r\n        })\r\n        return NextResponse.json(profile)\r\n    } catch (err: any) {\r\n        console.error('[API/PROFILE/ENSURE] Unexpected error:', err)\r\n        return NextResponse.json(\r\n            { error: 'Internal Server Error' },\r\n            { status: 500 }\r\n        )\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}